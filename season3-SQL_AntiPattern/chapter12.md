# 第12章 インデックスショットガン（闇雲インデックス）
| -      | -          |
|:-------|:-----------|
| タイトル   | SQLアンチパターン |
| 起票日 | 2019/07/09 |
| 起票者 | @yoshioH   |
| 機能   | -          |

## 現象と期待動作
最近、一覧表示のレスポンスが遅ぇYo！昔はもっと早かったYo!  
それだけじゃねぇ、違う機能はCSV一括更新もクソ遅いYo!

### 再現手順
（割愛）

## 原因と対処方法
`MENTORの法則` に基づいた調査と修正計画を立てる。
### 1. Measure（測定）
スロークエリはよく耳にするよね。
なにはともあれ、現状の情報収拾から始めるのは性能改善に限らず全般的に言えることだと思う。

実際は、どんなにクエリが疑わしくても、全体のスループットを測定することから始めるべき。
`1+N問題` は意外とよく出くわすので覚えておくといいかも。

### 2. Explain（解析）
クエリの実行計画をとって、どういう検索をしているのかを解析する。

### 3. Nominate
インデックスの指名はいりますー。
解析はあくまで事実の確認に止めるのであって、仮定を立てるのはこの段階で実施するということかな？
とはいえ、実際は実行計画をとる前にSQLをみて気づくことも多々ある。

### 4. Test
まぁ、再計測くらいするよね。
Excelとかで作った簡易なレポートも大事。

### 5. Optimize
モノによってはテーブル自体をメモリにロードしておくという手もある。例えば、MySQLでは`MEMORY`指定したテーブルにすることもできる。
```sql
CREATE TABLE lookup
    (id INT, INDEX USING BTREE (id)) -- BTREEの他にHASHもあるらしい
    ENGINE = MEMORY;
```
更新の多いテーブルだとあまり効果がない（https://dev.mysql.com/doc/refman/5.6/ja/memory-storage-engine.html）から気をつけて。

### 6. Rebuild
インデックスの再構築。確かに大規模なデータを扱う場合は定期的にインデックスのはりなおしはしておいたほうがいい。

闇雲にインデックスを貼っていたテーブルを大量更新するあまり、更新も遅い、インデックスもうまく効かないって話もあったり。。

## 所感
**「推測より計測」** は至言ですね。

第3章のIDリクアイアドを敢えて適応してインデックスを適用しなくても、PK一撃で取得できるようにしといたり、13章の`NULL`にしないように気をつけたりと、広い範囲の知識や工夫が必要になるなぁと、いい意味で色々と思うところのある章だった。

アンチパターンやイケてないSQLやテーブルは大抵が性能劣化しやすい印象。
